# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Skip if no files staged
if [ -z "$STAGED_FILES" ]; then
  echo "No staged files to check"
  exit 0
fi

echo "ğŸ” Running pre-commit checks..."

# Step 1: Format code with Prettier (only on supported files)
echo "ğŸ“ Formatting code with Prettier..."
FORMATTABLE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json|md|css|html)$' || true)

if [ -n "$FORMATTABLE_FILES" ]; then
  echo "$FORMATTABLE_FILES" | xargs --no-run-if-empty npx prettier --write --ignore-unknown

  # Check if prettier made any changes and add them
  if ! git diff --quiet -- "$FORMATTABLE_FILES" 2>/dev/null; then
    echo "ğŸ“ Prettier made changes, adding formatted files..."
    echo "$FORMATTABLE_FILES" | xargs git add
  else
    echo "âœ… Code already properly formatted"
  fi
else
  echo "â„¹ï¸ No formattable files in staged changes"
fi

# Step 2: ESLint auto fix (only on JS/TS files)
echo "ğŸ”§ Running ESLint auto-fix..."
LINTABLE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx)$' || true)

if [ -n "$LINTABLE_FILES" ]; then
  echo "$LINTABLE_FILES" | xargs --no-run-if-empty npx eslint --fix --quiet

  # Check if eslint made any changes and add them
  if ! git diff --quiet -- "$LINTABLE_FILES" 2>/dev/null; then
    echo "ğŸ”§ ESLint made changes, adding fixed files..."
    echo "$LINTABLE_FILES" | xargs git add
  fi
else
  echo "â„¹ï¸ No lintable files in staged changes"
fi

# Step 3: Final ESLint check
echo "âœ… Final lint check..."
if [ -n "$LINTABLE_FILES" ]; then
  echo "$LINTABLE_FILES" | xargs --no-run-if-empty npx eslint --max-warnings=0 || {
    echo "âŒ ESLint errors found. Please fix them before committing."
    echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix issues"
    exit 1
  }
else
  echo "â„¹ï¸ No lintable files to check"
fi

# Step 4: TypeScript check
echo "ğŸ” Type checking..."
npx tsc --noEmit || {
  echo "âŒ TypeScript errors found. Please fix them before committing."
  echo "ğŸ’¡ Run 'npm run type-check' to see detailed errors"
  exit 1
}

# Step 5: Security audit
echo "ğŸ”’ Security audit..."
npm audit --audit-level=moderate || {
  echo "âŒ Security vulnerabilities found. Please fix them before committing."
  echo "ğŸ’¡ Run 'npm audit fix' to auto-fix issues"
  exit 1
}

echo "âœ… All pre-commit checks passed!"
